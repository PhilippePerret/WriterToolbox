<%
# Vue pour lire un sujet
#
# NOTE À UTILISER
#   Mettre une ancre "post_<id post>" aux posts, pour pouvoir y venir
#   depuis n'importe où.

# Raccourci pour obtenir l'instance du sujet
def sujet
  @sujet ||= begin
    # Attention, parfois on revient ici après fait quelque chose sur
    # un message et le sujet de la route est peut-être un post. Il
    # faut donc faire un test et, le cas échéant prendre le sujet du
    # message édité
    if site.objet.instance_of?( Forum::Sujet)
      # On en profite aussi pour marquer le sujet lu, sauf si l'user
      # l'a déjà lu dans cette session courante. Mais noter qu'un autre
      # jour, ou au cours d'une autre sesson du même jour, il pourra
      # rajouter un incrément au nombre de fois où le sujet a été vu.
      site.objet
    elsif site.objet.instance_of?(Forum::Post)
      site.objet.sujet
    else
      raise "Impossible de déterminer le sujet, dans forum/sujet/read.erb. La classe de site.objet est #{site.objet.class}."
    end
  end
end

def bouton_nouveau_message
  @bouton_nouveau_message ||= begin
    if user.identified?
      if user.grade > 2
        sujet.lien_write_post(sujet.data_type[:titre_new_post], {class:'btn small'})
      else
        "Votre grade est insuffisant pour pouvoir répondre".in_span(class:'small italic')
      end
    else
      (lien.signup("Inscrivez-vous") + " ou " + lien.subscribe("abonnez-vous") + " pour pouvoir profiter pleinement du forum").in_span(class:'small italic')
    end.in_div(class:'right')
  end
end
%>

<%
# ---------------------------------------------------------------------
#   INCRÉMENTER LE NOMBRE DE VUES DE CE SUJET S'IL LE FAUT

unless app.session['forum_sujets_vus'] != nil && app.session['forum_sujets_vus'].match(/:#{sujet.id}:/)
  site.objet.incremente_vues
  app.session['forum_sujets_vus'] ||= ""
  app.session['forum_sujets_vus'] << ":#{sujet.id}:"
end

# / Incrémentation nombre de vues
# ---------------------------------------------------------------------
%>
<%= forum.titre_h2(sujet.name, {onglets: true}) %>
<%= bouton_nouveau_message %>
<%= sujet.div_infos_sujet %>

<% if sujet.count > 0 %>
  <%= sujet.posts(from: 0, as: :ul) %>
<% end %>
<% if sujet.count > 3 %><%= bouton_nouveau_message %><% end %>
