<%
# Affiche l'analyse du film courant, qu'elle soit "TM" ou normale
%>
<%
def film ; @film ||= FilmAnalyse::Film::current end

if false == film.exist?
  raise "Ce film n'existe pas, désolé."
elsif true #false == film.consultable? # sous-entendu: par le visiteur courant
  raise_unless film.consultable?, "Désolé, mais vous n'avez pas les autorisations nécessaires pour visualiser cette analyse."
end
%>

<%
# ---------------------------------------------------------------------
#   Si l'on passe ici, c'est que l'user a les privilèges qu'il faut
#   pour visualiser l'analyse.
# ---------------------------------------------------------------------
%>

<%
# Si c'est une analyse TM (TextMate) il faut la charger dans une
# frame puisque c'est un fichier complet.
if film.analyse_tm?

%>
  <iframe
    id="frame_analyse"
    width="100%"
    height="100%"
    src="<%= film.html_file.to_s %>"
    style="position:fixed;top:0;left:0"></iframe>
<%
# Il faut ajouter du code pour supprimer l'interface normal pour
# qu'on puisse voir la page analyse complète.
%>
<script type="text/javascript">
$(document).ready(function(){
  $('section').hide();
  $('section#content').show();
})
</script>

<%

else
  # Si ce n'est pas une analyse TM

  # Pour le traitement des anciennes données (avant Films TM)
  # Toutes ces données se trouvent dans le dossier ./data/analyse/data_per_film/
  FilmAnalyse::require_module 'archives'
  page.add_css "./data/analyse/css"
  page.add_javascript "./data/analyse/javascript"

%>
  <%= FilmAnalyse::titre_h1(film.titre, {onglets_top: true}) %>
  <%= film.all_data %>
<% end %>
