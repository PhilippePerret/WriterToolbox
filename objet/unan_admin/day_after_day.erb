<%
raise_unless_admin
#
# Page permettant d'afficher le programme jour après jour comme si
# on le suivait de façon rapide.
#
%>
<h1>Programme UnAn</h1>
<%
# ---------------------------------------------------------------------
# Section qui contient les données actuelles en fonction du jour
# à commencer par le nombre de points
# ---------------------------------------------------------------------
%>

<div id="dad_state">
  <%= Unan::DAD.total_points_upto %>
</div>

<%
# Fenêtre d'affichage
%>
<div id="dad_content">
  <div class='pday'>
    <%= pday_courant.edit_buttons %>
    <h3>
      <%= pday_courant.id %><sup><%= pday_courant.id == 1 ? 'er' : 'e' %></sup>
      P-Day : <%= pday_courant.titre %>
    </h3>
    <%  def warning_non_defini; '(pas de description générale pour ce jour-programme)'.in_span(class:'warning') end %>
    <%= (pday_courant.description || warning_non_defini).in_div(class:'description') %>

    <%
    # D'abord, on affiche les works qui démarrent vraiment au p-day
    # courant.
    works_today = pday_courant.works(:as_instances)
    %>
    <h4>Nouveaux travaux</h4>
    <div id="works_OF_pday" class="panneau_onglet">
      <% if works_today.count == 0 %>
        <p class='retrait4'>Aucun nouveau travail aujourd'hui.</p>
      <% else %>
        <% works_today.each do |iwork| %>
          <%= iwork.as_card(from: 0) %>
                      <%
                        # Le `from:0` ci-dessus permet d'ajouter la class
                        # 'first_day' au div du travail pour indiquer qu'il
                        # commence maintenant
                      %>
        <% end %>
      <% end %>
    </div>
    <%
    # Ensuite, on affiche les works qui continuent sur le p-day
    # en fonction de leur durée.
    #
    # On distingue les travaux s'achevant et les travaux se
    # poursuivant.
    continuing = pday_courant.continuing_works
    acheving  = continuing.select{|wid,wdata| wdata[:reste] == 0}
    poursuing = continuing.reject{|wid,wdata| wdata[:reste] == 0}
    %>
    <div id="works_ON_pday" class="panneau_onglet">
      <h4>Travaux s'achevant aujourd'hui</h4>
      <% if acheving.count == 0 %>
        <p class='retrait4'>Aucun travail ne s'achève aujourd'hui.</p>
      <% else %>
        <% acheving.each do |wid, wdata| %>
          <%= wdata[:instance].as_card(from: wdata[:diff]) %>
        <% end %>
      <% end %>
      <h4>Travaux se poursuivant</h4>
      <% if poursuing.count == 0 %>
        <p class='retrait4'>Aucun travail ne se poursuit aujourd'hui.</p>
      <% else %>
        <% poursuing.each do |wid, wdata| %>
          <%= wdata[:instance].as_card(from: wdata[:diff]) %>
        <% end %>
      <% end %>
    </div>
  </div>
</div>


<%
# Bandeau de navigation, sous la fenetre

%>
<div id="dad_navigation">
  <%=
    (
      Unan::DAD.lien_works_map +
      Unan::DAD.checkbox_fenetre_fixe
    ).in_div(class:'btns fleft small') %>
  <%
  prev_ipday = pday_courant.id.to_i - 1
  prev_visibility = prev_ipday > 0 ? "visible" : "hidden"
  iem = prev_ipday == 1 ? "er" : "e"
  prev_num = "#{prev_ipday}<sup>#{iem}</sup>".in_span(class:'tiny')
  next_ipday = pday_courant.id.to_i + 1
  next_visibility = next_ipday < 366 ? "visible" : "hidden"
  next_num = "#{next_ipday}<sup>e</sup>".in_span(class:'tiny')
  %>
  <%= "#{prev_num} ◀️".in_a(class:'btnnav', style:"visibility:#{prev_visibility}", href:"unan_admin/day_after_day?pday=#{prev_ipday}") %>
  <%= Unan::DAD::menu_jours %>
  <%= "▶️ #{next_num}".in_a(class:'btnnav', style:"visibility:#{next_visibility}",href:"unan_admin/day_after_day?pday=#{next_ipday}") %>
</div>


<%
# Si les paramètres le demandent il faut bloquer la fenêtre
# au rechargement
%>
<script type="text/javascript">
$(document).ready(function(){
  UI.bloquer_la_page(true)
})
</script>

<div class="small">
  <h3>Explications</h3>
  <p>
    Ce module permet de consulter le programme <%= Unan::PROGNAME_MAJ %> jour
    après jour.
  </p>
  <p>
    Les tâches (works) entourées d'un cadre vert sont les tâches démarrées
    le jour courant.
  </p>
  <p>
    Les tâches entourées d'un cadre rouge sont les tâches commencées les
    jours précédants et qui doivent être achevées le jour courant.
  </p>
</div>
