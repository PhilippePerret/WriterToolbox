<%
# Affichage de la liste des QCM
#
# Note : N'affiche que les dernières versions des questionnaires.
# Pour les autres versions, utiliser un lien direct.
%>
<%= Unan::titre_h1("Liste des Quiz/questionnaires/sondages") %>
<%
site.require_objet 'unan'
Unan::require_module 'quiz'
UnanAdmin::require_module 'quiz'

class ::Unan
class Quiz
  # Méthode utilisée par tous les quiz pour s'afficher dans un li,
  # version finale comme version précédente.
  def as_li_item
    ajout_titre = next_version_id ? " (version du #{created_at.as_human_date})".in_span(class:'tiny') : ""
    ("[#{id}]".in_span(class:'tiny')+" #{titre}#{ajout_titre}" + " #{lien_edit('[edit]')} #{lien_simulation('[simule]')}".in_span(class:'small')).in_li
  end
end #/Quiz
end #/Unan



# Traite les versions précédente
# Note : Ne le fait que si ces versions précédentes existent
# (au moins une) donc on peut y aller sans crainte.
def traite_versions_precedentes_of iquiz_prev
  c = ""
  begin
    iquiz_prev = iquiz_prev.previous_version
    debug "* Traitement de la version précédente #{iquiz_prev.titre} (##{iquiz_prev.id})"
    c << iquiz_prev.as_li_item
  end while iquiz_prev.previous_version != nil
  c.in_ul(class:'quiz_list')
end


def liste_questionnaires
  # On traite tous les questionnaires pour obtenir les
  # versions précédentes aussi et les afficher, mais en plus petit
  html = ""

  ::Unan::table_quiz.select(colonnes:[:id]).each do |hquiz|
    qid = hquiz[:id]
    iquiz = ::Unan::Quiz::new(qid)

    # On passe les quiz qui ont une version suivante, ils seront
    # traités par la dernière version
    next if iquiz.next_version_id != nil

    # On traite un quiz qui est une version finale
    debug "* Traitement de “#{iquiz.titre}” (##{iquiz.id}) qui est une version finale."
    html << iquiz.as_li_item

    # On traite les versions précédente du quiz
    unless iquiz.previous_version_id.nil?
      debug "  Quiz ##{iquiz.id} possède une version précédente (##{iquiz.previous_version_id})"
      html << traite_versions_precedentes_of(iquiz)
    end

  end

  return html
end
%>

<ul id="quiz_list">
  <%= liste_questionnaires %>
</ul>
